# CockroachDB Lab

Experimenting with CockroachDB to Create a Resilient Database Cluster

# Steps

## 1. Create a Kubernetes Cluster

1. For this experiment, I'm using GKE.

    ```
    gcloud container clusters create cockroachdb
    ```

2. Once done, grep account information from the cluster.

    ```
    gcloud info | grep Account
    ```

3. Create RBAC roles needed for CockroachDB to run on GKE.

    ```
    kubectl create clusterrolebinding $USER-cluster-admin-binding --clusterrole=cluster-admin --user=<your.google.cloud.email@example.org>
    ```

## 2. Deploy CockroachDB

1. Install Helm client, if not installed already.

    For Mac OS, the command is as follow:
    ```
    brew install kubernetes-helm
    ```

2. Install Helm server and its required RBAC.

    Create a `rbac-config.yaml` to define a role and service account.

    ```
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: tiller
      namespace: kube-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: tiller
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: cluster-admin
    subjects:
      - kind: ServiceAccount
        name: tiller
        namespace: kube-system
    ```

    Create the service account.

    ```
    kubectl create -f rbac-config.yaml
    ```

   Init Helm server:

    ```
    helm init --service-account tiller
    ```

3. Install CockroachDB Helm chart.

    Install with the following command:

    ```
    helm install --name qbl-cockroach --set Secure.Enabled=true stable/cockroachdb
    ```

    After that, we see approve CSR for pods generated by CockroachDB
chart:

    ```
    kubectl get csr
    kubectl certificate approve default.node.qbl-cockroach-cockroachdb-0
    kubectl certificate approve default.node.qbl-cockroach-cockroachdb-1
    kubectl certificate approve default.node.qbl-cockroach-cockroachdb-2
    kubectl certificate approve default.client.root
    ```

## 3. Use Built-In SQL Client

1. Create a client pod

    Create `client-secure.yaml` pod definition as follow:

    ```
    apiVersion: v1
    kind: Pod
    metadata:
      name: cockroachdb-client-secure
      labels:
        app: cockroachdb-client
    spec:
      serviceAccountName: qbl-cockroach-cockroachdb
      initContainers:
      - name: init-certs
        image: cockroachdb/cockroach-k8s-request-cert:0.4
        imagePullPolicy: IfNotPresent
        command:
        - "/bin/ash"
        - "-ecx"
        - "/request-cert -namespace=${POD_NAMESPACE} -certs-dir=/cockroach-certs -type=client -user=root -symlink-ca-from=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        volumeMounts:
        - name: client-certs
          mountPath: /cockroach-certs
      containers:
      - name: cockroachdb-client
        image: cockroachdb/cockroach:v2.1.3
        imagePullPolicy: IfNotPresent
        volumeMounts:
        - name: client-certs
          mountPath: /cockroach-certs
        command:
        - sleep
        - "2147483648" # 2^31
      terminationGracePeriodSeconds: 0
      volumes:
      - name: client-certs
        emptyDir: {}
    ```

    Create the pod:

    ```
    kubectl create -f client-secure.yaml
    ```

2. SSH into the client pod.

    ```
    kubectl exec -it cockroachdb-client-secure -- ./cockroach sql --certs-dir=/cockroach-certs --host=qbl-cockroach-cockroachdb-public
    ```

3. Try out some SQL commands.

    ```
    CREATE DATABASE bank;
    CREATE TABLE bank.accounts (id INT PRIMARY KEY, balance DECIMAL);
    INSERT INTO bank.accounts VALUES (1, 1000.50);
    SELECT * FROM bank.accounts;
    ```

4. Create a user with a password.

    Replace <username> and <password> in the following command with
username and password that you want.

    ```
    CREATE USER <username> WITH PASSWORD '<password>';
    ```

5. Exit the SQL shell and pod with `\q` command.

## 4. Accessing The Admin UI

1. Port-forward from local machine.

    ```
    kubectl port-forward qbl-cockroach-cockroachdb-0 8080
    ```

2. Access from `localhost:8080`.


# Experiments

## 1. Node Failure

## 2. Data Replication

## 3. Fault Tolerance & Recovery
